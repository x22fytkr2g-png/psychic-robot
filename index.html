<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexDrop v14 | Logistics & Social OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #ffffff; --text: #000000; --blue: #2563eb; --glass: rgba(255, 255, 255, 0.9); --border: rgba(0,0,0,0.1); }
        .dark-mode { --bg: #020617; --text: #ffffff; --blue: #3b82f6; --glass: rgba(15, 23, 42, 0.9); --border: rgba(255,255,255,0.1); }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; transition: 0.4s; overflow-x: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide { display: none; width: 100%; height: 400px; object-fit: cover; border-radius: 2.5rem; }
        .slide.active { display: block; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; display: inline-block; }
        .online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .offline { background: #94a3b8; }
        
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 13px; margin-bottom: 8px; }
        .sent { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: #f1f5f9; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        .dark-mode .received { background: #1e293b; color: white; }

        #adminChatBox { display: none; position: fixed; bottom: 90px; right: 25px; width: 320px; height: 450px; z-index: 1000; flex-direction: column; }
    </style>
</head>
<body>

    <div id="authGate" class="min-h-screen flex items-center justify-center px-6">
        <div class="max-w-md w-full glass p-10 rounded-[3rem] text-center shadow-2xl">
            <h1 class="text-4xl font-black text-blue italic tracking-tighter mb-2">NEXDROP</h1>
            <p class="text-[10px] font-bold opacity-40 uppercase tracking-[0.3em] mb-8">Secure Access Portal</p>
            
            <div id="regFields" class="hidden space-y-4 mb-4">
                <input type="text" id="regName" placeholder="Full Name" class="w-full bg-black/5 p-4 rounded-2xl outline-none border border-transparent focus:border-blue">
            </div>
            <input type="email" id="authEmail" placeholder="Email" class="w-full bg-black/5 p-4 rounded-2xl outline-none mb-4">
            <input type="password" id="authPass" placeholder="Password" class="w-full bg-black/5 p-4 rounded-2xl outline-none mb-6">
            
            <button onclick="handleAuth()" class="w-full bg-blue text-white font-black py-4 rounded-2xl shadow-lg">INITIALIZE</button>
            <button onclick="toggleAuth()" id="toggleBtn" class="text-[10px] font-black uppercase opacity-50 mt-6 hover:text-blue">Create New Account</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="fixed top-0 w-full z-[100] px-4 py-4">
            <div class="max-w-6xl mx-auto glass rounded-[2rem] p-3 flex justify-between items-center px-8 shadow-xl">
                <h1 class="text-2xl font-black text-blue cursor-pointer" onclick="showPage('home')">ND</h1>
                <div class="hidden md:flex gap-8 items-center">
                    <button onclick="showPage('home')" class="flex flex-col items-center text-[9px] font-black uppercase"><i class="fa-solid fa-house text-lg mb-1"></i>Home</button>
                    <button onclick="showPage('social')" class="flex flex-col items-center text-[9px] font-black uppercase"><i class="fa-solid fa-users text-lg mb-1"></i>Network</button>
                    <button onclick="showPage('messages')" class="flex flex-col items-center text-[9px] font-black uppercase"><i class="fa-solid fa-comment-dots text-lg mb-1"></i>Chat</button>
                    <button onclick="showPage('profile')" class="border-l border-blue/20 pl-6"><img id="navPfp" class="w-10 h-10 rounded-full border-2 border-blue object-cover"></button>
                    <button onclick="toggleTheme()" class="text-xl ml-4">ðŸŒ“</button>
                </div>
                <div class="md:hidden flex gap-4">
                    <button onclick="showPage('messages')" class="text-xl"><i class="fa-solid fa-comment-dots"></i></button>
                    <button onclick="toggleMenu()" class="text-xl text-blue"><i class="fa-solid fa-bars-staggered"></i></button>
                </div>
            </div>
        </nav>

        <main id="home" class="page active pt-32 px-6 max-w-2xl mx-auto pb-24">
            <div class="relative mb-12 rounded-[2.5rem] overflow-hidden glass p-2 shadow-2xl">
                <img src="https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?w=800" class="slide active">
                <img src="https://images.unsplash.com/photo-1566576721346-d4a3b4eaad5b?w=800" class="slide">
            </div>
            <div id="blogContainer" class="space-y-12"></div>
        </main>

        <section id="messages" class="page pt-32 px-6 max-w-5xl mx-auto h-[85vh]">
            <div class="glass rounded-[3rem] h-full flex overflow-hidden shadow-2xl">
                <div class="w-1/3 border-r border-black/5 bg-black/5 flex flex-col">
                    <div id="sidebarFriends" class="flex-1 overflow-y-auto"></div>
                </div>
                <div class="flex-1 flex flex-col">
                    <div id="chatHeader" class="p-6 border-b border-black/5 font-black text-blue">Select a friend</div>
                    <div id="chatBox" class="flex-1 overflow-y-auto p-8 flex flex-col"></div>
                    <div id="chatInputArea" class="hidden p-6 border-t border-black/5 flex gap-3">
                        <input id="chatIn" class="flex-1 bg-black/5 p-4 rounded-2xl outline-none" placeholder="Type message...">
                        <button onclick="sendPrivateMsg()" class="bg-blue text-white px-8 rounded-2xl font-black">SEND</button>
                    </div>
                </div>
            </div>
        </section>

        <div id="adminChatBox" class="glass rounded-3xl overflow-hidden flex shadow-2xl">
            <div class="bg-blue p-4 text-white font-black text-[10px] flex justify-between"><span>SUPPORT</span><button onclick="toggleChat()">âœ•</button></div>
            <div id="admDisplay" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
            <div class="p-3 border-t flex gap-2">
                <input id="admIn" class="flex-1 bg-black/5 p-2 rounded-xl text-xs outline-none" placeholder="Ask Admin...">
                <button onclick="sendAdmMsg()" class="bg-blue text-white px-4 rounded-xl font-bold">SEND</button>
            </div>
        </div>
        <button onclick="toggleChat()" class="fixed bottom-6 right-6 bg-blue text-white w-14 h-14 rounded-full shadow-2xl z-50 flex items-center justify-center"><i class="fa-solid fa-headset text-xl"></i></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD7pEnf4eAAtuFfvy4ff-zt1s239lOjQB4",
            authDomain: "nextdrop-21a5e.firebaseapp.com",
            projectId: "nextdrop-21a5e",
            storageBucket: "nextdrop-21a5e.firebasestorage.app",
            messagingSenderId: "315627368280",
            appId: "1:315627368280:web:546d377a78463c3d8a7f2d",
            databaseURL: "https://nextdrop-21a5e-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        let session = JSON.parse(localStorage.getItem('user_persistent')) || null;
        let isLogin = true;

        // AUTH LOGIC
        function toggleAuth() { 
            isLogin = !isLogin; 
            document.getElementById('regFields').classList.toggle('hidden', isLogin);
            document.getElementById('toggleBtn').innerText = isLogin ? "Create New Account" : "Back to Login";
        }

        function handleAuth() {
            const email = document.getElementById('authEmail').value.trim().toLowerCase().replace(/\./g, ',');
            const pass = document.getElementById('authPass').value.trim();
            if(!email || !pass) return alert("Fill all fields");

            if(isLogin) {
                rdb.ref('users/'+email).once('value', s => {
                    const u = s.val();
                    if(u && u.pass === pass) { 
                        localStorage.setItem('user_persistent', JSON.stringify(u)); 
                        location.reload(); 
                    } else alert("Wrong credentials");
                });
            } else {
                const name = document.getElementById('regName').value;
                const u = { name, email, pass, pfp: "https://via.placeholder.com/150", loc: "Lagos", bio: "Available" };
                rdb.ref('users/'+email).set(u).then(() => {
                    localStorage.setItem('user_persistent', JSON.stringify(u));
                    location.reload();
                });
            }
        }

        // NAVIGATION & UI
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        function toggleChat() { const c = document.getElementById('adminChatBox'); c.style.display = (c.style.display === 'flex') ? 'none' : 'flex'; }
        
        // SLIDESHOW
        let sPos = 0;
        const slides = document.querySelectorAll('.slide');
        if(slides.length) setInterval(() => { slides[sPos].classList.remove('active'); sPos = (sPos + 1) % slides.length; slides[sPos].classList.add('active'); }, 4000);

        // SYNC & MESSAGING
        function initApp() {
            if(!session) {
                document.getElementById('authGate').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                return;
            }
            document.getElementById('authGate').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('navPfp').src = session.pfp;

            // Online Status
            const statusRef = rdb.ref(`status/${session.email}`);
            rdb.ref('.info/connected').on('value', snap => {
                if(snap.val()) {
                    statusRef.onDisconnect().set({ state: 'offline' });
                    statusRef.set({ state: 'online' });
                }
            });

            // Friends Sidebar
            rdb.ref(`users/${session.email}/friends`).on('value', s => {
                const sidebar = document.getElementById('sidebarFriends');
                sidebar.innerHTML = '';
                const friends = s.val() || {};
                Object.keys(friends).forEach(fEmail => {
                    rdb.ref('users/'+fEmail).once('value', us => {
                        const u = us.val();
                        rdb.ref('status/'+fEmail).on('value', ss => {
                            const isOnline = ss.val()?.state === 'online';
                            const div = document.createElement('div');
                            div.className = "p-4 flex items-center gap-4 hover:bg-blue/5 cursor-pointer border-b border-black/5";
                            div.onclick = () => startChat(fEmail, u.name);
                            div.innerHTML = `<div class="relative"><img src="${u.pfp}" class="w-10 h-10 rounded-full object-cover">
                                             <div class="absolute bottom-0 right-0 status-dot ${isOnline?'online':'offline'}"></div></div>
                                             <p class="text-xs font-bold">${u.name}</p>`;
                            sidebar.appendChild(div);
                        });
                    });
                });
            });

            // Admin Chat Sync
            rdb.ref(`admin_support/${session.email.replace(/,/g,'-')}`).on('value', s => {
                const msgs = s.val() ? Object.values(s.val()) : [];
                document.getElementById('admDisplay').innerHTML = msgs.map(m => `<div class="bubble ${m.sender===session.name?'sent':'received'}">${m.text}</div>`).join('');
            });
        }

        let activeChat = null;
        function startChat(email, name) {
            activeChat = email;
            document.getElementById('chatHeader').innerText = "Chatting with " + name;
            document.getElementById('chatInputArea').classList.remove('hidden');
            const key = [session.email, email].sort().join('_').replace(/,/g,'');
            rdb.ref(`chats/${key}`).on('value', s => {
                const msgs = s.val() ? Object.values(s.val()) : [];
                document.getElementById('chatBox').innerHTML = msgs.map(m => `<div class="bubble ${m.sender===session.email?'sent':'received'}">${m.text}</div>`).join('');
                const d = document.getElementById('chatBox'); d.scrollTop = d.scrollHeight;
            });
        }

        function sendPrivateMsg() {
            const val = document.getElementById('chatIn').value;
            if(!val || !activeChat) return;
            const key = [session.email, activeChat].sort().join('_').replace(/,/g,'');
            rdb.ref(`chats/${key}`).push({ sender: session.email, text: val });
            document.getElementById('chatIn').value = '';
        }

        function sendAdmMsg() {
            const val = document.getElementById('admIn').value;
            if(!val) return;
            rdb.ref(`admin_support/${session.email.replace(/,/g,'-')}`).push({ sender: session.name, text: val });
            document.getElementById('admIn').value = '';
        }

        initApp();
    </script>
</body>
</html>
