<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextDrop | Unified Logistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon: #00f2ff; --slate: #020617; }
        body { background: var(--slate); color: white; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        
        #authGate, #mainApp, #adminPortal { display: none; position: absolute; inset: 0; background: var(--slate); overflow-y: auto; z-index: 10; }
        .page { display: none; animation: fadeIn 0.4s ease-out; padding-bottom: 120px; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .item-card { background: rgba(30, 41, 59, 0.4); border-radius: 1.5rem; border: 1px solid rgba(255,255,255,0.03); transition: 0.3s; }
        .slide-item { position: absolute; inset: 0; opacity: 0; transition: 0.8s ease-in-out; }
        .slide-item.active { opacity: 1; }

        input, textarea { background: rgba(255,255,255,0.07) !important; color: white !important; border-radius: 12px; border: none !important; }
        .btn-main { background: var(--neon); color: black; font-weight: 800; border-radius: 1rem; transition: 0.2s; }
        
        /* Profile Layout Fix */
        .profile-container { background: linear-gradient(145deg, rgba(15,23,42,0.8), rgba(2,6,23,0.9)); backdrop-blur: 15px; border: 1px solid rgba(0,242,255,0.1); }
    </style>
</head>
<body>

    <div id="authGate" class="flex items-center justify-center p-6 bg-slate-950">
        <div class="max-w-md w-full text-center">
            <h1 class="text-5xl font-black italic mb-2 tracking-tighter">NextDrop</h1>
            <p id="authSub" class="text-[10px] text-cyan-400 font-bold uppercase tracking-[0.4em] mb-10">Welcome Back</p>
            <div class="bg-slate-900/50 p-8 rounded-[2.5rem] border border-white/5 space-y-4">
                <div id="signupFields" class="hidden space-y-4">
                    <input type="text" id="regName" placeholder="Full Name" class="w-full p-4 outline-none">
                </div>
                <input type="email" id="authEmail" placeholder="Email Address" class="w-full p-4 outline-none">
                <input type="password" id="authPass" placeholder="Access Key" class="w-full p-4 outline-none">
                <button onclick="handleAuth()" id="mainAuthBtn" class="w-full btn-main py-4">INITIALIZE</button>
                <div class="flex flex-col gap-3 pt-4">
                    <button onclick="toggleAuthMode()" id="switchAuthBtn" class="text-xs font-bold text-slate-400">New here? <span class="text-cyan-400">Create Account</span></button>
                    <button onclick="initRecovery()" class="text-[9px] uppercase tracking-widest font-black text-cyan-400/40">Forgot Access Key?</button>
                </div>
            </div>
        </div>
    </div>

    <div id="recoveryModal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="bg-slate-900 p-8 rounded-[2.5rem] w-full max-w-sm text-center border border-cyan-500/20">
            <h2 class="text-xl font-black mb-6">RECOVERY_MODE</h2>
            <div id="recStep1" class="space-y-4">
                <input type="email" id="recEmail" placeholder="Enter Neural Email" class="w-full p-4 outline-none">
                <button onclick="sendRecoveryCode()" class="w-full btn-main py-4">VERIFY RECORD</button>
            </div>
            <div id="recStep2" class="hidden space-y-4">
                <p class="text-xs text-cyan-400">Record found. Enter new key.</p>
                <input type="password" id="newKey" placeholder="New Access Key" class="w-full p-4 outline-none">
                <button onclick="resetKey()" class="w-full btn-main py-4">UPDATE_KEY</button>
            </div>
            <button onclick="closeRecovery()" class="mt-6 text-[10px] text-red-500 font-black uppercase">Cancel</button>
        </div>
    </div>

    <div id="mainApp">
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 w-[92%] max-w-lg bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-full px-8 py-4 flex justify-between items-center shadow-2xl">
            <button onclick="showPage('market')" class="text-cyan-400"><i class="fa-solid fa-store"></i></button>
            <button onclick="showPage('orders')" class="text-slate-400"><i class="fa-solid fa-truck-fast"></i></button>
            <button onclick="toggleChat()" class="text-slate-400"><i class="fa-solid fa-headset"></i></button>
            <button onclick="showPage('profile')" class="w-10 h-10 rounded-full border-2 border-cyan-400 overflow-hidden">
                <img id="navPfp" class="w-full h-full object-cover">
            </button>
        </nav>

        <main id="market" class="page active pt-10 px-6 max-w-xl mx-auto">
            <div id="slideshow" class="h-44 rounded-[2rem] bg-slate-900 mb-8 border border-white/5 overflow-hidden relative shadow-2xl flex items-center justify-center text-[10px] opacity-20">Syncing...</div>
            <div id="marketGrid" class="space-y-6"></div>
        </main>

        <section id="orders" class="page pt-10 px-6 max-w-xl mx-auto">
            <h2 class="text-2xl font-black mb-6">Shipments</h2>
            <div id="orderList" class="space-y-4"></div>
        </section>

        <section id="profile" class="page pt-10 px-6 max-w-md mx-auto">
            <div class="profile-container p-8 rounded-[3rem] text-center shadow-2xl">
                <div class="relative w-32 h-32 mx-auto mb-4">
                    <img id="profPfp" class="w-full h-full rounded-full object-cover border-4 border-cyan-400 shadow-[0_0_15px_rgba(0,242,255,0.3)]">
                    <label for="pfpFile" class="absolute bottom-1 right-1 bg-cyan-500 text-black w-9 h-9 rounded-full flex items-center justify-center cursor-pointer border-4 border-slate-950">
                        <i class="fa-solid fa-camera text-xs"></i>
                    </label>
                    <input type="file" id="pfpFile" class="hidden" onchange="uploadToCloud(this, 'pfp')">
                </div>
                
                <h2 id="profNameDisplay" class="text-2xl font-black tracking-tight text-white mb-1 uppercase">Loading...</h2>
                <p id="profLocDisplay" class="text-[10px] text-cyan-400 font-bold uppercase tracking-widest mb-6">Global Operative</p>
                
                <div class="space-y-3 pt-6 border-t border-white/5">
                    <input id="editLoc" placeholder="Update Zone/Location" class="w-full p-3 text-xs outline-none">
                    <textarea id="editBio" placeholder="Update Neural Bio..." class="w-full p-3 text-xs outline-none h-20"></textarea>
                    <button onclick="saveProfile()" class="w-full btn-main py-3 text-xs">SYNC IDENTITY</button>
                    <button onclick="logout()" class="w-full text-red-500 text-[10px] font-black tracking-widest pt-6 uppercase">Disconnect</button>
                </div>
            </div>
        </section>

        <div id="chatBox" class="fixed bottom-28 right-6 w-80 h-[400px] bg-slate-950 border border-cyan-400/30 rounded-[2rem] hidden flex-col overflow-hidden shadow-2xl z-50">
            <div class="bg-cyan-400 p-4 text-black font-black text-[10px] flex justify-between">
                <span>SYSTEM SUPPORT</span>
                <button onclick="toggleChat()">âœ•</button>
            </div>
            <div id="chatDisplay" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
            <div class="p-4 border-t border-white/5 flex gap-2">
                <input id="chatInput" class="flex-1 p-2 rounded-lg text-xs outline-none" placeholder="Message Admin...">
                <button onclick="sendMsg()" class="text-cyan-400 px-2"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD7pEnf4eAAtuFfvy4ff-zt1s239lOjQB4",
            authDomain: "nextdrop-21a5e.firebaseapp.com",
            projectId: "nextdrop-21a5e",
            databaseURL: "https://nextdrop-21a5e-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        let session = JSON.parse(localStorage.getItem('user_persistent')) || null;
        let isSignUpMode = false;
        let lastUploadedUrl = "";

        // --- AUTH ---
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('signupFields').classList.toggle('hidden');
            document.getElementById('authSub').innerText = isSignUpMode ? "Identity Creation" : "Welcome Back";
            document.getElementById('mainAuthBtn').innerText = isSignUpMode ? "CREATE ACCOUNT" : "INITIALIZE";
            document.getElementById('switchAuthBtn').innerHTML = isSignUpMode ? 'Already have an account? <span class="text-cyan-400">Login</span>' : 'New here? <span class="text-cyan-400">Create Account</span>';
        }

        function handleAuth() {
            const email = document.getElementById('authEmail').value.toLowerCase().replace(/\./g, ',');
            const pass = document.getElementById('authPass').value;
            if(!email || !pass) return alert("Fill fields");
            if(isSignUpMode) {
                const name = document.getElementById('regName').value;
                if(!name) return alert("Name required");
                const u = { name, email, pass, pfp: `https://ui-avatars.com/api/?name=${name}&background=00f2ff&color=000`, loc: 'Unknown Zone', bio: 'NextDrop User' };
                rdb.ref('users/'+email).set(u).then(() => { localStorage.setItem('user_persistent', JSON.stringify(u)); location.reload(); });
            } else {
                rdb.ref('users/'+email).once('value', s => {
                    const u = s.val();
                    if(u && u.pass === pass) { localStorage.setItem('user_persistent', JSON.stringify(u)); location.reload(); }
                    else alert("Access Denied");
                });
            }
        }

        // --- UPLOAD ---
        async function uploadToCloud(input, type) {
            const file = input.files[0]; if(!file) return;
            const formData = new FormData(); formData.append('image', file);
            try {
                const res = await fetch('https://api.imgbb.com/1/upload?key=67f6b0f15c7e3995f560c5a242f36d4f', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.success) {
                    lastUploadedUrl = data.data.url;
                    if(type === 'pfp') { 
                        document.getElementById('profPfp').src = lastUploadedUrl; 
                        alert("Photo Ready! Hit Sync to save.");
                    }
                }
            } catch(e) { alert("Upload Failed"); }
        }

        // --- PROFILE ---
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'profile') {
                const u = JSON.parse(localStorage.getItem('user_persistent'));
                document.getElementById('profPfp').src = u.pfp;
                document.getElementById('navPfp').src = u.pfp;
                document.getElementById('profNameDisplay').innerText = u.name;
                document.getElementById('profLocDisplay').innerText = u.loc || 'Global Operative';
                document.getElementById('editLoc').value = u.loc || '';
                document.getElementById('editBio').value = u.bio || '';
            }
        }

        function saveProfile() {
            const u = JSON.parse(localStorage.getItem('user_persistent'));
            const loc = document.getElementById('editLoc').value;
            const bio = document.getElementById('editBio').value;
            const update = { ...u, pfp: lastUploadedUrl || u.pfp, loc, bio };
            rdb.ref('users/'+u.email).update(update).then(() => {
                localStorage.setItem('user_persistent', JSON.stringify(update));
                alert("Identity Synced!");
                showPage('profile');
            });
        }

        // --- CORE ---
        function initApp() {
            if(!session) { document.getElementById('authGate').style.display = 'flex'; return; }
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('navPfp').src = session.pfp;

            rdb.ref('posts').on('value', s => {
                const posts = Object.entries(s.val() || {});
                document.getElementById('marketGrid').innerHTML = posts.map(([id, p]) => `
                    <div class="item-card overflow-hidden">
                        <img src="${p.img}" class="w-full h-48 object-cover">
                        <div class="p-6 flex justify-between items-center">
                            <div><h3 class="font-bold text-lg">${p.title}</h3></div>
                            <button onclick="order('${p.title}')" class="bg-cyan-500 text-black px-5 py-2 rounded-xl text-xs font-black">ORDER</button>
                        </div>
                    </div>`).join('');
                
                const featured = posts.filter(([id, p]) => p.featured);
                if(featured.length) {
                    let cur = 0;
                    const render = () => {
                        const itm = featured[cur][1];
                        document.getElementById('slideshow').innerHTML = `
                        <div class="slide-item active flex items-end p-8 w-full h-full relative">
                            <img src="${itm.img}" class="absolute inset-0 w-full h-full object-cover -z-10 opacity-50">
                            <div><h2 class="text-2xl font-black mt-1">${itm.title}</h2></div>
                        </div>`;
                        cur = (cur + 1) % featured.length;
                    };
                    render(); setInterval(render, 4000);
                }
            });
        }

        function order(t) { rdb.ref('orders/ORD-'+Date.now()).set({ item: t, user: session.email, status: 'pending' }); alert("Order Logged!"); }
        function logout() { localStorage.clear(); location.reload(); }
        function toggleChat() { document.getElementById('chatBox').classList.toggle('hidden'); }
        
        initApp();
    </script>
</body>
</html>
